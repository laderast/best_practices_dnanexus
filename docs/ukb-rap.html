<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Best Practices on the DNAnexus Platform - 3&nbsp; Work Effectively on the UK Biobank Research Analysis Platform (UKB RAP)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./spark-on-dnanexus.html" rel="next">
<link href="./project_management.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Work Effectively on the UK Biobank Research Analysis Platform (UKB RAP)</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Best Practices on the DNAnexus Platform</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./object-based-file-systems.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Object Based File Systems</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./project_management.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Project and File Management</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ukb-rap.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Work Effectively on the UK Biobank Research Analysis Platform (UKB RAP)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spark-on-dnanexus.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spark on the DNAnexus Platform</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dx_extract_dataset_R.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title"><code>dx extract_dataset</code> in R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hail-skills.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Hail Skills and Concepts</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hail-gwas.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">GWAS using Hail</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#who-this-chapter-is-for" id="toc-who-this-chapter-is-for" class="nav-link active" data-scroll-target="#who-this-chapter-is-for"><span class="toc-section-number">3.1</span>  Who This Chapter is For</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="toc-section-number">3.2</span>  Introduction</a></li>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives"><span class="toc-section-number">3.3</span>  Learning Objectives</a></li>
  <li><a href="#whats-different" id="toc-whats-different" class="nav-link" data-scroll-target="#whats-different"><span class="toc-section-number">3.4</span>  What’s Different?</a></li>
  <li><a href="#application-id-and-sharing" id="toc-application-id-and-sharing" class="nav-link" data-scroll-target="#application-id-and-sharing"><span class="toc-section-number">3.5</span>  Application ID and Sharing</a></li>
  <li><a href="#data-dispensal" id="toc-data-dispensal" class="nav-link" data-scroll-target="#data-dispensal"><span class="toc-section-number">3.6</span>  Data Dispensal</a></li>
  <li><a href="#pseudonymization-and-participant-ids" id="toc-pseudonymization-and-participant-ids" class="nav-link" data-scroll-target="#pseudonymization-and-participant-ids"><span class="toc-section-number">3.7</span>  Pseudonymization and Participant IDs</a></li>
  <li><a href="#phenogeno-data" id="toc-phenogeno-data" class="nav-link" data-scroll-target="#phenogeno-data"><span class="toc-section-number">3.8</span>  Pheno/Geno Data</a></li>
  <li><a href="#bulk-files" id="toc-bulk-files" class="nav-link" data-scroll-target="#bulk-files"><span class="toc-section-number">3.9</span>  Bulk Files</a>
  <ul class="collapse">
  <li><a href="#search-on-field-id" id="toc-search-on-field-id" class="nav-link" data-scroll-target="#search-on-field-id"><span class="toc-section-number">3.9.1</span>  Search on Field ID</a></li>
  <li><a href="#search-on-eid" id="toc-search-on-eid" class="nav-link" data-scroll-target="#search-on-eid"><span class="toc-section-number">3.9.2</span>  Search on EID</a></li>
  </ul></li>
  <li><a href="#example-jobs-on-ukb" id="toc-example-jobs-on-ukb" class="nav-link" data-scroll-target="#example-jobs-on-ukb"><span class="toc-section-number">3.10</span>  Example Jobs on UKB</a></li>
  <li><a href="#extract" id="toc-extract" class="nav-link" data-scroll-target="#extract"><span class="toc-section-number">3.11</span>  Extracting Pheno Data from the RAP Dataset</a></li>
  <li><a href="#using-jupyterlab-on-rap" id="toc-using-jupyterlab-on-rap" class="nav-link" data-scroll-target="#using-jupyterlab-on-rap"><span class="toc-section-number">3.12</span>  Using JupyterLab on RAP</a>
  <ul class="collapse">
  <li><a href="#using-statajupyterlab-on-rap" id="toc-using-statajupyterlab-on-rap" class="nav-link" data-scroll-target="#using-statajupyterlab-on-rap"><span class="toc-section-number">3.12.1</span>  Using Stata/JupyterLab on RAP</a></li>
  </ul></li>
  <li><a href="#using-rrstudio-on-rap" id="toc-using-rrstudio-on-rap" class="nav-link" data-scroll-target="#using-rrstudio-on-rap"><span class="toc-section-number">3.13</span>  Using R/RStudio on RAP</a>
  <ul class="collapse">
  <li><a href="#looking-at-files-in-your-rap-project" id="toc-looking-at-files-in-your-rap-project" class="nav-link" data-scroll-target="#looking-at-files-in-your-rap-project"><span class="toc-section-number">3.13.1</span>  Looking at files in your RAP Project</a></li>
  <li><a href="#reproducible-research-using-rstudio-on-rap" id="toc-reproducible-research-using-rstudio-on-rap" class="nav-link" data-scroll-target="#reproducible-research-using-rstudio-on-rap"><span class="toc-section-number">3.13.2</span>  Reproducible Research using RStudio on RAP</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Work Effectively on the UK Biobank Research Analysis Platform (UKB RAP)</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="who-this-chapter-is-for" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="who-this-chapter-is-for"><span class="header-section-number">3.1</span> Who This Chapter is For</h2>
<ul>
<li>You are a <em>bioinformatician</em> who wants to <em>run pipelines</em> or <em>custom software</em> on the UK Biobank data.</li>
<li>You are a <em>data scientist</em> or <em>epidemiologist</em> and you want to run analyses in RStudio on UKB RAP on either the pheno data or other data fields.</li>
<li>You are a <em>bioinformatician</em> or <em>data scientist</em> who wants to work in Jupyter notebooks using JupyterLab on UKB RAP.</li>
<li>You <em>want to explore</em> the UKB Pheno Data using the Cohort Browser platform on UKB RAP.</li>
</ul>
</section>
<section id="introduction" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="introduction"><span class="header-section-number">3.2</span> Introduction</h2>
<p>The UK Biobank Research Analysis Platform (UKB RAP) gives you the ability to work with one of the largest cohorts of people: over 500,000 participants.</p>
<p>If you’re coming from either analyzing data on your own machine or from HPC computing, there are some key differences that you will have to learn.</p>
<p>This chapter attempts to give you the knowledge you need to work successfully on UKB RAP.</p>
</section>
<section id="learning-objectives" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">3.3</span> Learning Objectives</h2>
<ol type="1">
<li><strong>Explain</strong> key differences with the UK Biobank Research Analysis Platform (RAP) and the core DNAnexus platform.</li>
<li><strong>Explain</strong> how to process files using built in apps on RAP using Swiss Army Knife.</li>
<li><strong>Identify</strong> two key methods for extracting Pheno Data in a RAP project.</li>
<li><strong>Explain</strong> the two main strategies for listing and accessing files in a RAP project in JupyterLab or RStudio (<code>dx find data</code> versus <code>/mnt/project/</code>).</li>
<li><strong>Utilize</strong> JupyterLab on RAP reproducibly with Python/R/bash.</li>
<li><strong>Utilize</strong> RStudio on RAP reproducibly.</li>
</ol>
</section>
<section id="whats-different" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="whats-different"><span class="header-section-number">3.4</span> What’s Different?</h2>
<p>Here are the main differences with UK Biobank and the Core DNAnexus Platform.</p>
<ol type="1">
<li>On UKB RAP, you need to apply for access and note what fields are relevant for your work. When the UK Biobank team has reviewed it, you will be assigned an Application ID.</li>
<li>On UKB RAP, you are limited to sharing projects within your own application ID. All billing information is attached to the application ID, rather than to an organization.</li>
<li>On UKB RAP, data is <em>dispensed</em> when requested at project creation or refresh. This is both the pheno data (the <code>dataset</code>) and the Bulk, or file based data.</li>
<li>On UKB RAP, The participant identifiers (<code>eid</code>s) are different across applications because of the psuedonymization process.</li>
<li>On UKB RAP, there is a <code>Bulk/</code> File Folder that contains many of the files you want to analyze. This includes pVCF files, but also metabolomics data, imaging data, accelerometer data, and proteomics data, as well.</li>
</ol>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Don’t forget about UK Biobank Community!
</div>
</div>
<div class="callout-body-container callout-body">
<p>The UK Biobank Community (at <a href="https://community.dnanexus.com" class="uri">https://community.dnanexus.com</a>) is an incredible resource to ask questions, see answers, learn about webinars/tutorials, and understand.</p>
<p>Just know that you’re part of a huge group of researchers who are learning to use RAP and they have probably encountered similar issues to you.</p>
</div>
</div>
</section>
<section id="application-id-and-sharing" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="application-id-and-sharing"><span class="header-section-number">3.5</span> Application ID and Sharing</h2>
<p>When you <a href="https://dnanexus.gitbook.io/uk-biobank-rap/frequently-asked-questions#what-is-an-access-application">file an access application with UK Biobank</a>, you need to supply a list of fields that you will use in your research.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/ukb_application.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">UKB Application Process</figcaption><p></p>
</figure>
</div>
</section>
<section id="data-dispensal" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="data-dispensal"><span class="header-section-number">3.6</span> Data Dispensal</h2>
<p>The <a href="https://dnanexus.gitbook.io/uk-biobank-rap/getting-started/creating-a-project#dispensing-data">data dispensal process</a> begins when you create a RAP project within your application ID. When you request data to be dispensed, it may take 20 minutes to several hours for the data to appear in your project, depending on the data fields you have requested in your application.</p>
<p>When data is dispensed, two things happen in your project:</p>
<ol type="1">
<li>A <code>/Bulk/</code> folder is created in your project that contains files associated with data, such as <code>.vcf.gz</code> files, or geno data in <code>BGEN</code> format.</li>
<li>A <a href="https://dnanexus.gitbook.io/uk-biobank-rap/getting-started/working-with-ukb-data#database-and-dataset"><code>dataset</code></a> is created in your project, which contains both the pheno data fields and the processed geno fields. This dataset consists of multiple Spark Databases. This dataset can be browsed using the <a href="https://dnanexus.gitbook.io/uk-biobank-rap/getting-started/working-with-ukb-data#browsing-dataset-fields-using-the-cohort-browser">Cohort Browser</a> if you click on it in your project.</li>
</ol>
<p>When the data is refreshed on RAP (which may take a few weeks to months following its release on UKB Showcase), you are able to <a href="https://dnanexus.gitbook.io/uk-biobank-rap/getting-started/updating-dispensed-data">update the dispensed Data</a>.</p>
</section>
<section id="pseudonymization-and-participant-ids" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="pseudonymization-and-participant-ids"><span class="header-section-number">3.7</span> Pseudonymization and Participant IDs</h2>
<p>Within an application, participant IDs (also known as EIDs) are unique, through the <a href="https://dnanexus.gitbook.io/uk-biobank-rap/frequently-asked-questions#how-are-eids-used-on-the-research-analysis-platform">pseudonymization process</a>. This process has been done to ensure security and anonymity of participants.</p>
<p>This means that you <strong>cannot join data across applications</strong>.</p>
<p>For example, if I’m in application ID <code>43333</code> and you’re in application <code>11111</code>, our EIDs will not correspond because we both have a set of unique EIDs. Our data files are also mapped to these unique IDs.</p>
<p>So if I make a pheno matrix with EIDs and you want to reuse this pheno matrix in your application, it won’t work, because our EIDs don’t match up.</p>
</section>
<section id="phenogeno-data" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="phenogeno-data"><span class="header-section-number">3.8</span> Pheno/Geno Data</h2>
<p>Pheno and Processed Geno Data are stored within multiple Spark databases within your RAP Project. These physical databases are accessed through a single object called the <em>dataset</em>.</p>
<p>There is a built in application called <em>Cohort Browser</em> that will let you explore data fields and derive <em>cohorts</em> by building <em>filters</em> on the data. These cohorts can be shared with others on your application.</p>
<p>Once you have derived cohorts, you can extract the pheno fields by using table exporter or extracting the data.</p>
</section>
<section id="bulk-files" class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="bulk-files"><span class="header-section-number">3.9</span> Bulk Files</h2>
<p>The other difference with UKB RAP is that a lot of the data (image, genomics, etc) are available as files that have been dispensed into your <a href=""><code>Bulk/</code> folder</a>.</p>
<p>Here are a few examples of searching for bulk files using <code>dx find data</code>:</p>
<section id="search-on-field-id" class="level3" data-number="3.9.1">
<h3 data-number="3.9.1" class="anchored" data-anchor-id="search-on-field-id"><span class="header-section-number">3.9.1</span> Search on Field ID</h3>
</section>
<section id="search-on-eid" class="level3" data-number="3.9.2">
<h3 data-number="3.9.2" class="anchored" data-anchor-id="search-on-eid"><span class="header-section-number">3.9.2</span> Search on EID</h3>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
UKB Showcase is Your Friend
</div>
</div>
<div class="callout-body-container callout-body">
<p>When you work with the UKB Pheno Data, you will need to find Field IDs for particular fields that you’re interested in. Sometimes there are multiple measurements/instances for Field IDs.</p>
<p>To understand the structure of the data (and what field IDs to grab), I highly recommend using <a href="https://biobank.ndph.ox.ac.uk/showcase/">UKB Showcase</a> to browse the fields and <a href="https://biobank.ndph.ox.ac.uk/showcase/search.cgi">search for fields of interest</a>.</p>
</div>
</div>
</section>
</section>
<section id="example-jobs-on-ukb" class="level2" data-number="3.10">
<h2 data-number="3.10" class="anchored" data-anchor-id="example-jobs-on-ukb"><span class="header-section-number">3.10</span> Example Jobs on UKB</h2>
<blockquote class="blockquote">
<p>For a review of running jobs and useful bash tips, please check out <a href="https://laderast.github.io/bash_for_bioinformatics/">Bash for Bioinformatics</a>, especially the <a href="https://laderast.github.io/bash_for_bioinformatics/04-doing-work-with-dx-run.html">Using <code>dx run</code></a> and <a href="https://laderast.github.io/bash_for_bioinformatics/05-batch-processing.html">Batch Processing</a> chapters.</p>
</blockquote>
</section>
<section id="extract" class="level2" data-number="3.11">
<h2 data-number="3.11" class="anchored" data-anchor-id="extract"><span class="header-section-number">3.11</span> Extracting Pheno Data from the RAP Dataset</h2>
<p>This is a question we get a lot. I’ll explain two ways to extract the pheno data:</p>
<ol type="1">
<li><em>If you are less command-line savvy</em>: Use the <a href="https://documentation.dnanexus.com/developer/apps/developing-spark-apps/table-exporter-application">Table Exporter App</a> to export the phenotype fields to a CSV file. You have the option to select a decoded file when you run it.</li>
<li><em>If you have started to use <code>dx-toolkit</code></em>: Use the <code>dx-toolkit</code> command <a href="dx_extract_dataset_python.ipynb"><code>dx extract_dataset</code> from Python</a> or <a href="./dx_extract_dataset_R.html"><code>dx extract_dataset</code> from R</a> to extract raw values to a CSV file, and decode the file manually. If your query takes longer than 2 minutes to run, then you will have to start a Spark JupyterLab Cluster and run the SQL query generated by <code>dx extract_dataset</code> with the <code>--sql</code> option.</li>
</ol>
<p>The first thing you need to do is identify the dataset in your project. Make sure that you chose to dispense data in your project (see above), and the dataset should be in the root of your project and begin with <code>dataset-</code>.</p>
<p>You’ll want to grab the record ID for your dataset. You can find it by selecting your dataset in the GUI and clicking the “i” button in the top-left.</p>
</section>
<section id="using-jupyterlab-on-rap" class="level2" data-number="3.12">
<h2 data-number="3.12" class="anchored" data-anchor-id="using-jupyterlab-on-rap"><span class="header-section-number">3.12</span> Using JupyterLab on RAP</h2>
<section id="using-statajupyterlab-on-rap" class="level3" data-number="3.12.1">
<h3 data-number="3.12.1" class="anchored" data-anchor-id="using-statajupyterlab-on-rap"><span class="header-section-number">3.12.1</span> Using Stata/JupyterLab on RAP</h3>
</section>
</section>
<section id="using-rrstudio-on-rap" class="level2" data-number="3.13">
<h2 data-number="3.13" class="anchored" data-anchor-id="using-rrstudio-on-rap"><span class="header-section-number">3.13</span> Using R/RStudio on RAP</h2>
<p>One of the nice features of RAP is that you can run R/RStudio on it.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Quick disambiguation note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Because there are two kinds of projects, the RAP Project and your RStudio Project, the discussion can be confusing.</p>
<p>I’ll refer to the RAP Project as <em>RAP Storage</em>, and the RStudio Project as a <em>RStudio Project</em>. Hopefully that will make things less ambiguous.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
How running RStudio on RAP is different
</div>
</div>
<div class="callout-body-container callout-body">
<p>The first thing you’ll notice is that the Files tab in RStudio is isolated from the project storage.</p>
<p>To access data in your RStudio project, you will have to use <code>dx download</code> or <code>dxFUSE</code> to load the data.</p>
<p>The second thing you might notice is that your installed libraries are not installed when you open a session.</p>
<p>These two issues make working with RStudio on RAP different than working with RStudio on your own machine.</p>
<p>Here’s a quick table that talks about the main differences with using RStudio on RAP compared to a local installation of RStudio.</p>
<table class="table">
<colgroup>
<col style="width: 10%">
<col style="width: 23%">
<col style="width: 66%">
</colgroup>
<thead>
<tr class="header">
<th>Feature</th>
<th>Local RStudio</th>
<th>RStudio on RAP</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Accessing Files</td>
<td>Has Access to your local filesystem</td>
<td>Access files in RAP Storage using <code>dxfuse</code> (<code>/mnt/project/myfile.txt/</code>) or using <code>dx download</code></td>
</tr>
<tr class="even">
<td>Installing Packages</td>
<td>Use <code>install.packages()</code></td>
<td>Init <code>renv</code> in project, then install packages</td>
</tr>
<tr class="odd">
<td>Saving Projects</td>
<td>Save files in project</td>
<td>Use snapshot <code>dx backup-folder</code> capability to save project folder to RAP Storage</td>
</tr>
<tr class="even">
<td>Opening Projects</td>
<td>Open <code>.rproj</code> file in Project</td>
<td>Use <code>dx restore-folder</code> to restore project folder, then open <code>.rproj</code> file</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Make sure you terminate!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Just because you have closed your RStudio Session does not mean that the job is terminated. Use the red terminate button on the top of the RStudio interface to stop the cloud worker.</p>
</div>
</div>
<section id="looking-at-files-in-your-rap-project" class="level3" data-number="3.13.1">
<h3 data-number="3.13.1" class="anchored" data-anchor-id="looking-at-files-in-your-rap-project"><span class="header-section-number">3.13.1</span> Looking at files in your RAP Project</h3>
<p>Let’s take a quick look at the files in our <code>/Bulk/</code> folder. In the RStudio console, we can use <code>list.files()</code> to do this.</p>
<p>Note we put a <code>/mnt/project/</code> in front of <code>/Bulk/</code>. This is how we access the file system contents using <code>dxFUSE</code>.</p>
<pre><code> list.files("/mnt/project/Bulk/")</code></pre>
<p>The response from the console is this:</p>
<pre><code>[1] "Activity"                                     "Brain MRI"               
[3] "Carotid Ultrasound"                           "Electrocardiogram"        
[5] "Exome sequences"                              "Exome sequences_Alternative exome processing"
[7] "Exome sequences_Previous exome releases"      "Genotype Results"         
[9] "Heart MRI"                                    "Imputation"              
[11] "Kidney MRI"                                   "Liver MRI"               
[13] "Pancreas MRI"                                 "Protein biomarkers"      
[15] "Retinal Optical Coherence Tomography"         "Whole Body DXA"          
[17] "Whole Body MRI"                               "Whole genome sequences"   </code></pre>
<p>Say we want to dive deeper into <code>Exome sequences</code>. We can run:</p>
<pre><code>list.files("/mnt/project/Bulk/Exome sequences")</code></pre>
<p>And we’ll see the different formats of the Exome data:</p>
<pre><code>[1] "Exome OQFE CRAM files"                                                   
[2] "Exome OQFE variant call files (VCFs)"                                    
[3] "Population level exome OQFE variants, BGEN format - final release"       
[4] "Population level exome OQFE variants, BGEN format - interim 450k release"
[5] "Population level exome OQFE variants, PLINK format - final release"    
[6] "Population level exome OQFE variants, PLINK format - interim 450k release"
[7] "Population level exome OQFE variants, pVCF format - final release"       
[8] "Population level exome OQFE variants, pVCF format - interim 450k release" </code></pre>
<p>Within each of these folders is a series of numbered folders that have two digits. The two digits (such as <code>11</code>) are the first two digits of the EIDs that are in the folder. For example, a file with an EID of <code>2281131</code> is going to be in <code>22/</code> folder.</p>
<p>There are some hard limits to the number of files that can be in a folder. Thus, each set of 500K files (such as <code>.vcf.gz</code>) is split up into multiple folders with about 10000 files in each.</p>
</section>
<section id="reproducible-research-using-rstudio-on-rap" class="level3" data-number="3.13.2">
<h3 data-number="3.13.2" class="anchored" data-anchor-id="reproducible-research-using-rstudio-on-rap"><span class="header-section-number">3.13.2</span> Reproducible Research using RStudio on RAP</h3>
<p>My key piece of advice when running RStudio on RAP is to use the following process:</p>
<p>For starting a project:</p>
<ol type="1">
<li>Initialize a new RStudio project.</li>
<li>Use <code>renv::init()</code> to initialize <code>renv</code> in your RStudio Project.</li>
<li>Install needed packages to your RStudio Project with <code>install.packages()</code>.</li>
<li>If you need to work with pheno data, use Table Exporter or <code>dx extract_dataset</code> to extract it to a CSV file on RAP Storage.</li>
<li>Load data either using <code>dx download</code> (for smaller batches of files) or dxFUSE (using paths like <code>/mnt/project/myfile.txt</code>).</li>
</ol>
<p>For working in your project:</p>
<ol type="1">
<li>Do your work, saving it as an <code>Rmarkdown</code> or <code>quarto</code> document.</li>
<li>Run <code>renv::snapshot()</code> in your RStudio project.</li>
<li>Use the <code>dx-toolkit</code> snapshot functionality in <code>dx-toolkit</code> to save (<code>dx backup-folder</code>) your project into RAP Storage. (<code>dx-backup-folder -d /.Backups/my_project.tar.gz</code>)</li>
</ol>
<p>For example, in an RStudio Project we can run this command in the terminal:</p>
<pre><code>dx-backup-folder -d /.Backups/rstudio_test_project.tar.gz</code></pre>
<p>In this command, we’re backing up the current RStudio Project folder into a file called <code>/.Backups/rstudio_test_project.tar.gz</code> on RAP storage. We’re using the <code>-d</code> (destination) option to do this. This will give us the following response:</p>
<pre><code>Folder . was successfully saved to /.Backups/rstudio_test_project.tar.gz ( file-GBFf5vQJ9Zz93fGk0X8pV2Bf )</code></pre>
<p>To resume an RStudio project:</p>
<ol type="1">
<li>To resume your work, restore (<code>dx restore-folder</code>) your RStudio project from RAP Storage.</li>
<li>Open up the <code>.rproj</code> file in RStudio to resume your RStudio project.</li>
<li>To install more packages, use <code>renv::activate()</code>, <code>install.packages()</code>, and then <code>renv::snapshot()</code>.</li>
<li>Use <code>dx backup-folder</code> to save your work.</li>
</ol>
<p>For example, we can use this command in our terminal to expand our <code>my_project.tar.gz</code> into a project folder called <code>my_project</code>:</p>
<pre><code>dx-restore-folder /.Backups/my_project.tar.gz -d my_project</code></pre>
<p>Once we click on the <code>.rproj</code> folder in our project, we can resume our work.</p>
<p>If we want to add new packages, we can run the following in the RStudio console:</p>
<pre><code>renv::activate()</code></pre>
<p>Then we can <code>install.packages()</code> as usual.</p>
<p>Then we do our work, and then when we’re done, we’ll use:</p>
<p>`<code>renv::snapshot()</code></p>
<p>to save our packages into our Project. Then we can use <code>dx-backup-folder</code> as usual.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What is <code>renv</code>?
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://rstudio.github.io/renv/articles/renv.html"><code>renv</code></a> is a R Package that implements virtual environments for your RStudio project.</p>
<p>In short, a virtual environment allows you to completely reproduce the <strong>software environment</strong> (all the packages with their version numbers) in your project.</p>
<p>How does <code>renv</code> work? Each RStudio Project has its own library of packages, which is modified as you install packages in your project. This is also handy in that you can work with multiple projects that each have their own version of a package.</p>
</div>
</div>
<p>This seems to be a lot of extra work. Why do it? Well, this process alleviates a lot of complaints about working with a cloud instance of RStudio:</p>
<ol type="1">
<li>It allows you to resume work on a RStudio project without having to reinstall packages or redownload data. Everything is saved in the project folder, which is then backed up to RAP Storage.</li>
<li>It ties your packages to version numbers. Sharing an RStudio Project with <code>renv</code>initialized means that your collaborators can install an identical software environment and reproduce your work.</li>
</ol>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./project_management.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Project and File Management</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./spark-on-dnanexus.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spark on the DNAnexus Platform</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>